
pipeline {
    agent {
        label 'mesos'
    }
    tools {
      nodejs '8'
    }
    stages {
        stage('Init') {
          steps {
            sh 'node -v'
            sh 'npm -v'

            sh 'npm set registry https://npm.paypal.com'
          }
        }
        stage('Install') {
          steps {
            sh 'npm install nodeops-cli es6-plato lcov-server -g'
            sh 'npm install'

            stash name: 'workspace', useDefaultExcludes: false
          }
        }
        stage('Lint') {
          steps {
            sh 'npm run lint'
          }
        }
        stage('Test') {
            steps {
                parallel (
                    "Node 4" : {
                      node('mesos') {
                        unstash 'workspace'
                        nodejs(nodeJSInstallationName: '4', configId: null) {
                          sh 'node -v'
                          sh 'npm rebuild'
                          sh 'npm test'
                        }
                      }
                    },
                    "Node 6" : {
                      node('mesos') {
                        unstash 'workspace'
                        nodejs(nodeJSInstallationName: '6', configId: null) {
                          sh 'node -v'
                          sh 'npm rebuild'
                          sh 'npm test'
                        }
                      }
                    },
                    "Node 8" : {
                      node('mesos') {
                        unstash 'workspace'
                        nodejs(nodeJSInstallationName: '8', configId: null) {
                          sh 'node -v'
                          sh 'npm rebuild'
                          sh 'npm test'
                        }
                      }
                    }
                )
            }
        }
        stage('Coverage') {
          steps {
            unstash 'workspace'
            sh 'npm rebuild'

            sh 'npm run cover'
            sh 'cat coverage/lcov.info | lcov-server --upload http://coverage.paypalcorp.com'

            publishHTML(target: [
              allowMissing: false,
              alwaysLinkToLastBuild: false,
              keepAll: true,
              reportDir: 'coverage/lcov-report',
              reportFiles: 'index.html',
              reportName: "HTML Coverage Report"
            ])

            sh 'wget https://raw.github.com/eriwen/lcov-to-cobertura-xml/master/lcov_cobertura/lcov_cobertura.py'
            sh 'python lcov_cobertura.py coverage/lcov.info'

            step([$class: 'CoberturaPublisher', coberturaReportFile: 'coverage.xml'])
          }
        }
        stage('Analysis') {
          steps {
            sh 'es6-plato -r -x "(PlatoReportCI|coverage|node_modules|dist|.build|.builds|(r|build|min)\\.js)" -d PlatoReportCI .'
            publishHTML(target: [
              allowMissing: false,
              alwaysLinkToLastBuild: false,
              keepAll: true,
              reportDir: 'PlatoReportCI',
              reportFiles: 'index.html',
              reportName: "Plato Report"
            ])
          }
        }
        stage('Analytics') {
          steps {
            sh 'nodeops-cli statistics'
          }
        }
    }
}