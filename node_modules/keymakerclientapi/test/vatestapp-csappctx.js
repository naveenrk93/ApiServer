'use strict';
var assert = require('assert');
var base64 = require('base64-paypal');
var cal = require('cal');
var topos = require('topos');
var nconf = require('nconf');
var rewire = require("rewire");
var kmClient;
var perfTest = true;

cal.setDefaultWriteStream('console');

function validAppName() {
    return 'validtestapp';
}
function validAppContextName() {
    return 'validtestapp_cryptoserv_app_context';
}
var TAKeyMakerClient;

describe('validTestApp-api-positive', function() {
    before('validTestApp-test-setup', function(next) {
        console.log("***before");
        TAKeyMakerClient = rewire('../lib/KeyMakerClient');
        TAKeyMakerClient.__set__("utils.getAppName", validAppName);
        TAKeyMakerClient.__set__("utils.getAppContextName", validAppContextName);
        console.time('validTestApp-test-setup');
        this.timeout(20000);
        process.env.SHARE_PWD = 'aardvark';

        var opt = {};
        opt.appname = 'validtestapp';
        opt.unitTest = true;
        // Initialize topo
        topos.init(nconf.get('topos'), nconf);

        TAKeyMakerClient.create(opt, function(err, obj) {
            if (err) {
                console.log('client-tests err obj: ' + err);
            }
            kmClient = obj;
            console.timeEnd('validTestApp-test-setup');
            next();
        });
    });
    
    it('validTestApp-cryptoserv-encrypt-decrypt-operation-test', function(next) { 
        var requestObject = {
            keyId: '101',
            data: new Buffer('05940893650789087'),
            isPKCS7: false
        };
        console.log('test...');
        console.time('validTestApp-cryptoserv-encrypt-decrypt-operation');

        try {                
            kmClient.encrypt(requestObject, function(error, res) {
                console.log(res);
                if (perfTest) {
                    assert(!error, 'No error');
                    assert(res.response_code === 200);
                    assert(res.result);
                    assert(typeof res.result.encodedData === 'string', 'encrypt api output expected to be a string');
                }
                console.log('*** validTestApp-cryptoserv-encrypt-decrypt-operation-test : ENCRYPT ***', error, res);

                requestObject = {
                    keyId: '101',
                    data: res.result.encodedData,
                    isPKCS7: false
                };

                kmClient.decrypt(requestObject, function(error, res) {
                    if (perfTest) {
                        //assert(!error, 'No error');
                        assert(res.response_code === 200);
                        assert(res.result);
                        assert(typeof res.result.encodedData === 'string', 'encrypt api output expected to be a string');
                    }
                    console.timeEnd('validTestApp-cryptoserv-encrypt-decrypt-operation');
                    assert(base64.decode(res.result.encodedData).toString() === '05940893650789087', 'expected to be equal');
                    assert(res.result.plainData instanceof Buffer, 'type expected to be Buffer');
                    assert(res.result.plainData.toString() === '05940893650789087', 'expected to be equal');

                    next();
                });
            });                                    
        } catch(err) {
            return next(err);
        }
    });
    
    it('cryptoserv-compatibility-match-hmac-from-java-with-node', function(next) {
        console.time('cryptoserv-compatibility-match-hmac-from-java-with-node');
        var requestObject = {
            keyId: '101',
            data: new Buffer('compatibility test #101')
        };
        kmClient.hmac(requestObject, function(error, res) {
            if (perfTest) {
                //assert(!error, 'No error');
                assert(res.response_code === 200);
                assert(res.result);
                assert(res.result.encodedData === 'oIAm0dlUysEhdX5q7amlyqgpg1Y=', 'expected to be equal');
            }
            console.log('*** cryptoserv-compatibility-match-hmac-from-java-with-node-test ***', error, res);
            console.timeEnd('cryptoserv-compatibility-match-hmac-from-java-with-node');
            next();
        });
    });

    after('keymaker shutdown', function(next) {
            TAKeyMakerClient.shutdown();
            next();
    });
});